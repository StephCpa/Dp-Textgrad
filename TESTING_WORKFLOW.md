# DP-TextGrad 测试工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    DP-TextGrad 测试路线图                         │
│                     (30 分钟 → 3 天)                              │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ START: 代码修复已完成                                              │
│ ✅ Phase 1-4: raw_score, 预算, 反馈, DPScoreRecord 修复            │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 1: 核心单元测试 (5 分钟) ⚡                                    │
│                                                                  │
│ $ python -m pytest tests/test_dp_es.py -v                       │
│                                                                  │
│ 验证:                                                             │
│ ✅ DPScorer 组合定理正确                                           │
│ ✅ CritiqueOption 哈希支持                                        │
│ ✅ 隐私预算计算正确                                                │
│                                                                  │
│ 预期: 6 passed ✅                                                 │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 2: Phase 修复验证 (10 分钟)                                   │
│                                                                  │
│ $ python test_phase2_simple.py                                  │
│ $ python test_debug_mode_fix.py                                 │
│                                                                  │
│ 验证:                                                             │
│ ✅ Phase 2: 基础组合 ε_total = 4×0.5 = 2.0                        │
│ ✅ Phase 2: 反馈默认禁用                                           │
│ ✅ Phase 4: 生产模式 records = []                                 │
│ ✅ Phase 4: 调试模式显示警告                                        │
│                                                                  │
│ 预期: ALL TESTS PASSED 🎉                                        │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 3: 严格审计 (5 分钟)                                          │
│                                                                  │
│ $ python test_strict_audit.py                                   │
│                                                                  │
│ 验证:                                                             │
│ ✅ K-S 检验: 噪声分布正确 (p-value > 0.05)                         │
│ ✅ 隐私损失: Pr[loss > ε] ≤ δ (95% 置信区间)                       │
│                                                                  │
│ 预期: 统计审计通过 ✅                                              │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 4: 快速功能测试 (5 分钟)                                       │
│                                                                  │
│ $ python test_dp_gsm8k_scalable.py --samples 10 --epsilon 5.0   │
│                                                                  │
│ 验证:                                                             │
│ ✅ 端到端 DP-ES 流程工作                                           │
│ ✅ 隐私预算正确消耗                                                │
│ ✅ 参数有改进 (improvement > 0)                                    │
│                                                                  │
│ 预期: 实验成功 ✅                                                  │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ 🎉 基础验证完成! (总计 ~30 分钟)                                    │
│                                                                  │
│ 成功标准:                                                         │
│ ✅ 所有单元测试通过                                                │
│ ✅ Phase 修复验证通过                                              │
│ ✅ 统计审计通过                                                    │
│ ✅ 功能测试通过                                                    │
│                                                                  │
│ 结论: 代码修复正确，可以扩大实验! 🚀                                │
└──────────────────────────────────────────────────────────────────┘
                            │
                            ▼
                ┌───────────┴───────────┐
                │   继续扩大规模?        │
                └───────────┬───────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              NO            │            YES
              │             │             │
              ▼             │             ▼
    ┌─────────────────┐    │    ┌────────────────────┐
    │   完成测试!      │    │    │ 选择实验规模         │
    │   可以部署或     │    │    └────────────────────┘
    │   撰写论文       │    │             │
    └─────────────────┘    │             ▼
                           │    ┌────────────────────┐
                           │    │ 中等规模 (100 题)   │
                           │    │ 2 小时              │
                           │    └────────────────────┘
                           │             │
                           │             ▼
                           │    ┌────────────────────┐
                           │    │ 大规模 (500 题)     │
                           │    │ 6-8 小时            │
                           │    └────────────────────┘
                           │             │
                           │             ▼
                           │    ┌────────────────────┐
                           │    │ 完整规模 (1000+ 题) │
                           │    │ 1-2 天              │
                           │    └────────────────────┘
                           │             │
                           └─────────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 分析结果 & 绘制曲线      │
                            │ - 隐私-效用权衡         │
                            │ - 不同 ε 对比           │
                            │ - 组合定理对比          │
                            └────────────────────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 🎓 论文级结果!           │
                            │ 可以发表学术论文         │
                            └────────────────────────┘
```

---

## 快速命令参考

### 基础验证 (30 分钟)

```bash
# 方式 1: 一键运行所有测试 (推荐)
./run_all_tests.sh

# 方式 2: 手动逐步运行
python -m pytest tests/test_dp_es.py -v
python test_phase2_simple.py
python test_debug_mode_fix.py
python test_strict_audit.py
python test_dp_gsm8k_scalable.py --samples 10
```

### 扩大规模

```bash
# 中等规模 (100 题, 2 小时)
python test_dp_gsm8k_scalable.py \
    --samples 100 \
    --epsilon 10.0 \
    --iterations 10 \
    --cache \
    --save results_100.json

# 大规模 (500 题, 6 小时)
python test_dp_gsm8k_scalable.py \
    --samples 500 \
    --epsilon 20.0 \
    --iterations 15 \
    --cache \
    --adaptive-clipping \
    --save results_500.json

# 隐私-效用权衡分析
for eps in 2.0 5.0 10.0 20.0; do
    python test_dp_gsm8k_scalable.py \
        --samples 100 \
        --epsilon $eps \
        --save "results_eps${eps}.json"
done
```

---

## 决策树

```
开始测试
    │
    ▼
是否完成 Phase 1-4 修复?
    │
    ├─ NO → 先完成修复
    │
    └─ YES
        │
        ▼
    运行基础验证 (30 分钟)
        │
        ▼
    所有测试通过?
        │
        ├─ NO → 检查错误日志，修复问题
        │
        └─ YES
            │
            ▼
        需要论文级结果?
            │
            ├─ NO → 完成! 可以部署
            │
            └─ YES
                │
                ▼
            有多少时间?
                │
                ├─ 2 小时   → 100 题实验
                ├─ 1 天     → 500 题实验
                └─ 2-3 天   → 1000+ 题 + 多组对比
                    │
                    ▼
                分析结果 → 撰写论文 → 完成! 🎓
```

---

## 时间规划建议

### 今天 (30 分钟)
- ✅ 运行 `./run_all_tests.sh`
- ✅ 确认所有测试通过
- ✅ 快速 GSM8K 验证 (10 题)

### 本周 (如果需要实验)
- 📊 100 题中等规模实验
- 📊 多个 ε 值对比
- 📊 绘制隐私-效用曲线

### 下周 (如果需要论文)
- 📈 500-1000 题大规模实验
- 📈 完整的消融实验
- 📈 与其他方法对比
- 📑 撰写论文

---

**创建日期**: 2025-12-16
**适用场景**: 所有用户，从快速验证到论文发表
